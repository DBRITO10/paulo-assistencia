<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simonetti - Gest√£o de Pulm√£o</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    :root {
      --primary: #004a99;
      --secondary: #6c757d;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
    }

    body { background-color: #f0f2f5; margin: 0; padding-bottom: 50px; }

    /* Navbar Responsiva */
    .navbar {
      display: flex;
      flex-direction: column;
      background: var(--primary);
      color: white;
      padding: 1rem;
      gap: 10px;
    }

    @media (min-width: 768px) {
      .navbar { flex-direction: row; justify-content: space-between; align-items: center; }
    }

    .user-box { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }

    /* Container de Busca Elegante */
    .search-bar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #f0f2f5;
      padding: 15px 0;
    }

    .search-bar input {
      width: 100%;
      padding: 15px;
      border-radius: 30px;
      border: 2px solid var(--primary);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      font-size: 1rem;
      outline: none;
    }

    /* Tabela e Cards Responsivos */
    .product-group {
      background: white;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .prod-header {
      background: #e9ecef;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 5px solid var(--primary);
    }

    .vol-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      padding: 10px 15px;
      border-top: 1px solid #eee;
      align-items: center;
      gap: 10px;
    }

    @media (max-width: 600px) {
      .vol-row { grid-template-columns: 1fr; border-bottom: 4px solid #f0f2f5; }
      .vol-actions { display: flex; justify-content: space-around; }
    }

    /* Modal Centralizado e Elegante */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 450px;
      position: relative;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header { border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 10px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: var(--dark); }

    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; }
    .badge-red { background: #ffd7d7; color: #d9534f; }
    .badge-green { background: #e2ffd7; color: #5cb85c; }
  </style>
</head>
<body>

  <div class="navbar">
    <div class="user-box">
      <a href="dashboard.html" style="color:white; text-decoration:none;"><strong>‚Üê Voltar</strong></a>
      <span id="userNameDisplay">Ol√°, Carregando...</span>
    </div>
    <div style="font-weight: bold; font-size: 1.2rem;">Assist√™ncia Simonetti</div>
    <button class="btn btn-danger" onclick="logout()">Sair</button>
  </div>

  <div class="content">
    
    <div class="search-bar">
      <input type="text" id="mainSearch" placeholder="üîç Buscar por Produto ou Volume..." onkeyup="filtrarEstoque()">
    </div>

    <div id="listaEstoque">
      </div>

  </div>

  <div id="modalMestre" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitulo">T√≠tulo do Modal</h3>
      </div>
      <div id="modalCorpo">
        </div>
      <div class="modal-footer">
        <button class="btn" onclick="fecharModal()" style="background:#ccc">Cancelar</button>
        <button id="btnConfirmar" class="btn btn-primary">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "./js/firebase-config.js";
    import { 
      collection, addDoc, getDocs, serverTimestamp, doc, updateDoc, increment, query, orderBy, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    let volumeAtual = null;
    let produtoAtual = null;

    // 1. Identifica√ß√£o do Usu√°rio
    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("userNameDisplay").innerText = `Ol√°, ${user.email.split('@')[0]}`;
        carregarEstoque();
      } else {
        window.location.href = "index.html";
      }
    });

    // 2. Carregar Dados (Produto + Volumes juntos)
    async function carregarEstoque() {
      const container = document.getElementById("listaEstoque");
      container.innerHTML = "<p>Sincronizando com Firestore...</p>";

      try {
        const prodSnap = await getDocs(query(collection(db, "produtos"), orderBy("nome", "asc")));
        const volSnap = await getDocs(collection(db, "volumes"));
        const listaVols = volSnap.docs.map(d => ({id: d.id, ...d.data()}));

        container.innerHTML = "";

        prodSnap.forEach(docP => {
          const p = docP.data();
          const pId = docP.id;
          const volumesDoProduto = listaVols.filter(v => v.produtoId === pId);

          let htmlGrupo = `
            <div class="product-group" data-search="${p.nome.toLowerCase()} ${p.codigo.toLowerCase()}">
              <div class="prod-header">
                <div><strong>${p.codigo}</strong> - ${p.nome}</div>
                <button class="btn btn-sm btn-primary" onclick="window.modalNovoVolume('${pId}', '${p.nome}')">+ Volume</button>
              </div>
          `;

          volumesDoProduto.forEach(v => {
            const dias = v.ultimaMovimentacao ? Math.floor((new Date() - v.ultimaMovimentacao.toDate())/(1000*60*60*24)) : 0;
            const badge = dias > 30 ? 'badge-red' : 'badge-green';
            
            htmlGrupo += `
              <div class="vol-row" data-search-vol="${v.descricao.toLowerCase()}">
                <div class="indent">‚Ü≥ ${v.descricao}</div>
                <div><strong>${v.quantidade}</strong> un</div>
                <div><span class="status-badge ${badge}">${dias} dias parado</span></div>
                <div class="vol-actions">
                  <button class="btn btn-sm btn-success" onclick="window.movimentar('${v.id}', '${v.descricao}', 'Entrada')">‚ñ≤</button>
                  <button class="btn btn-sm btn-danger" onclick="window.movimentar('${v.id}', '${v.descricao}', 'Sa√≠da')">‚ñº</button>
                  <button class="btn btn-sm btn-warning" onclick="window.editarVolume('${v.id}', '${v.descricao}')">‚úé</button>
                </div>
              </div>
            `;
          });

          htmlGrupo += `</div>`;
          container.innerHTML += htmlGrupo;
        });
      } catch (e) {
        console.error(e);
      }
    }

    // 3. Sistema de Busca Inteligente (Mant√©m o Produto vis√≠vel se o Volume for achado)
    window.filtrarEstoque = () => {
      const termo = document.getElementById("mainSearch").value.toLowerCase();
      const grupos = document.querySelectorAll(".product-group");

      grupos.forEach(grupo => {
        const textoProduto = grupo.getAttribute("data-search");
        const volumes = grupo.querySelectorAll(".vol-row");
        let produtoVisivel = textoProduto.includes(termo);
        let algumVolumeVisivel = false;

        volumes.forEach(vol => {
          const textoVol = vol.getAttribute("data-search-vol");
          if (textoVol.includes(termo) || textoProduto.includes(termo)) {
            vol.style.display = "grid";
            algumVolumeVisivel = true;
          } else {
            vol.style.display = "none";
          }
        });

        grupo.style.display = (produtoVisivel || algumVolumeVisivel) ? "block" : "none";
      });
    };

    // 4. Modais Centralizados Profissionais
    window.movimentar = (id, desc, tipo) => {
      volumeAtual = id;
      document.getElementById("modalTitulo").innerText = `${tipo}: ${desc}`;
      document.getElementById("modalCorpo").innerHTML = `
        <label>Quantidade:</label>
        <input type="number" id="qtdMov" style="width:100%; font-size:24px; text-align:center; padding:10px;" autofocus>
      `;
      document.getElementById("btnConfirmar").onclick = () => processarMovimentacao(tipo, desc);
      abrirModal();
    };

    const processarMovimentacao = async (tipo, desc) => {
      const qtd = parseInt(document.getElementById("qtdMov").value);
      if(!qtd || qtd <= 0) return;

      const vRef = doc(db, "volumes", volumeAtual);
      await updateDoc(vRef, {
        quantidade: increment(tipo === 'Sa√≠da' ? -qtd : qtd),
        ultimaMovimentacao: serverTimestamp()
      });

      await addDoc(collection(db, "movimentacoes"), {
        produto: desc, tipo, quantidade: qtd, usuario: auth.currentUser.email, data: serverTimestamp()
      });

      fecharModal();
      carregarEstoque();
    };

    window.editarVolume = (id, desc) => {
      volumeAtual = id;
      document.getElementById("modalTitulo").innerText = `Editar Nome do Volume`;
      document.getElementById("modalCorpo").innerHTML = `
        <input type="text" id="novoNomeVol" value="${desc}" style="width:100%; padding:10px;">
      `;
      document.getElementById("btnConfirmar").onclick = async () => {
        const novo = document.getElementById("novoNomeVol").value;
        await updateDoc(doc(db, "volumes", volumeAtual), { descricao: novo });
        fecharModal();
        carregarEstoque();
      };
      abrirModal();
    };

    window.modalNovoVolume = (pId, pNome) => {
        produtoAtual = pId;
        document.getElementById("modalTitulo").innerText = `Novo Volume: ${pNome}`;
        document.getElementById("modalCorpo").innerHTML = `
            <input type="text" id="nvDesc" placeholder="Descri√ß√£o (ex: Volume 1/2)" style="width:100%; margin-bottom:10px; padding:10px;">
            <input type="number" id="nvQtd" placeholder="Quantidade inicial" style="width:100%; padding:10px;">
        `;
        document.getElementById("btnConfirmar").onclick = async () => {
            const d = document.getElementById("nvDesc").value;
            const q = parseInt(document.getElementById("nvQtd").value);
            await addDoc(collection(db, "volumes"), {
                produtoId: produtoAtual, descricao: d, quantidade: q, ultimaMovimentacao: serverTimestamp()
            });
            fecharModal();
            carregarEstoque();
        };
        abrirModal();
    }

    // Helpers UI
    const abrirModal = () => document.getElementById("modalMestre").style.display = "flex";
    window.fecharModal = () => document.getElementById("modalMestre").style.display = "none";
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

  </script>
</body>
</html>
