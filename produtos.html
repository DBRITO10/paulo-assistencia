<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simonetti - Gest√£o de Pulm√£o</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    :root {
      --primary: #004a99;
      --danger: #dc3545;
      --success: #28a745;
      --warning: #f0ad4e;
    }

    body { background-color: #f4f7f6; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    /* Navbar Compacta */
    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--primary); color: white; padding: 8px 20px;
    }
    .user-info { display: flex; align-items: center; gap: 15px; font-size: 14px; }

    /* √Årea de Cadastro Compacta (Estilo Antigo) */
    .cadastro-container {
      background: white; padding: 15px 20px; margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .cadastro-grid {
      display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;
    }
    .cadastro-grid div { flex: 1; min-width: 150px; }
    .cadastro-grid label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #555; }
    .cadastro-grid input, .cadastro-grid select { 
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
    }
    .btn-salvar { background: var(--success); color: white; border: none; padding: 9px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }

    /* Busca e Tabela */
    .content { padding: 0 20px; }
    .search-box { margin: 15px 0; }
    .search-box input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; }

    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 14px; }
    th { background: #eee; color: #333; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
    td { padding: 8px 10px; border-bottom: 1px solid #eee; }

    /* Estilo de Linhas (Giro) */
    .row-produto { background: #f9f9f9; font-weight: bold; }
    .row-volume { background: #ffffff; }
    .indent { padding-left: 30px; color: #666; font-style: italic; }
    
    /* Modais Centralizados */
    .modal {
      display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); align-items: center; justify-content: center;
    }
    .modal-content {
      background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    .btn-acao { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; color: white; margin-right: 3px; }

    @media (max-width: 600px) {
      .cadastro-grid div { flex: 100%; }
    }
  </style>
</head>
<body>

  <div class="navbar">
    <div class="user-info">
      <a href="dashboard.html"><button style="background:#6c757d; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">‚Üê Voltar</button></a>
      <span id="txtUsuario">Ol√°, Usu√°rio</span>
    </div>
    <div style="font-weight:bold">Controle Simonetti</div>
    <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Sair</button>
  </div>

  <div class="cadastro-container">
    <div class="cadastro-grid">
      <div>
        <label>C√≥d. SKU</label>
        <input type="text" id="cod" placeholder="Ex: G-101">
      </div>
      <div style="flex: 2;">
        <label>Descri√ß√£o do Produto</label>
        <input type="text" id="nome" placeholder="Nome do Produto">
      </div>
      <div>
        <label>Fornecedor</label>
        <select id="selectFornecedor"><option value="">Carregando...</option></select>
      </div>
      <button class="btn-salvar" id="btnSalvarProd">Salvar</button>
    </div>
  </div>

  <div class="content">
    <div class="search-box">
      <input type="text" id="inputBusca" placeholder="üîç Buscar produto ou volume..." onkeyup="filtrarTabela()">
    </div>

    <table id="tabelaEstoque">
      <thead>
        <tr>
          <th>C√≥digo / Descri√ß√£o</th>
          <th style="width: 100px; text-align: center;">Qtd</th>
          <th style="width: 150px; text-align: center;">Status</th>
          <th style="width: 180px; text-align: right;">A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="modalMestre" class="modal">
    <div class="modal-content">
      <h3 id="modalTitulo" style="margin-top:0; color:var(--primary)">A√ß√£o</h3>
      <div id="modalCorpo"></div>
      <div class="modal-footer">
        <button onclick="fecharModal()" style="background:#bbb; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Cancelar</button>
        <button id="btnConfirmar" class="btn-salvar">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { collection, addDoc, getDocs, serverTimestamp, doc, updateDoc, increment, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    let idAtivo = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("txtUsuario").innerText = `Bem-vindo, ${user.email.split('@')[0]}`;
        carregarTudo();
        carregarFornecedores();
      } else { window.location.href = "index.html"; }
    });

    async function carregarFornecedores() {
      const snap = await getDocs(collection(db, "fornecedores"));
      const select = document.getElementById("selectFornecedor");
      select.innerHTML = '<option value="">Selecione...</option>';
      snap.forEach(d => select.innerHTML += `<option value="${d.id}">${d.data().nome}</option>`);
    }

    // Cadastro de Produto
    document.getElementById("btnSalvarProd").onclick = async () => {
      const n = document.getElementById("nome").value;
      const f = document.getElementById("selectFornecedor").value;
      if(!n || !f) return alert("Preencha Nome e Fornecedor!");
      await addDoc(collection(db, "produtos"), {
        nome: n, codigo: document.getElementById("cod").value || "S/C",
        fornecedorId: f, dataCadastro: serverTimestamp()
      });
      location.reload();
    };

    async function carregarTudo() {
      const container = document.querySelector("#tabelaEstoque tbody");
      const prodSnap = await getDocs(query(collection(db, "produtos"), orderBy("nome", "asc")));
      const volSnap = await getDocs(collection(db, "volumes"));
      const listaVols = volSnap.docs.map(d => ({id: d.id, ...d.data()}));

      container.innerHTML = "";
      prodSnap.forEach(docP => {
        const p = docP.data();
        container.innerHTML += `
          <tr class="row-produto" data-busca="${p.nome.toLowerCase()} ${p.codigo.toLowerCase()}">
            <td>${p.codigo} - ${p.nome}</td>
            <td colspan="2" style="text-align:center">--</td>
            <td style="text-align:right">
              <button class="btn-acao" style="background:var(--primary)" onclick="window.modalVol('${docP.id}', '${p.nome}')">+ Volume</button>
            </td>
          </tr>`;

        listaVols.filter(v => v.produtoId === docP.id).forEach(v => {
          container.innerHTML += `
            <tr class="row-volume" data-busca-vol="${v.descricao.toLowerCase()}">
              <td class="indent">‚Ü≥ ${v.descricao}</td>
              <td style="text-align:center"><strong>${v.quantidade}</strong></td>
              <td style="text-align:center; font-size:11px;">Giro: ${v.ultimaMovimentacao ? 'Ativo' : '--'}</td>
              <td style="text-align:right">
                <button class="btn-acao" style="background:var(--success)" onclick="window.movimentar('${v.id}', '${v.descricao}', 'Entrada')">‚ñ≤</button>
                <button class="btn-acao" style="background:var(--danger)" onclick="window.movimentar('${v.id}', '${v.descricao}', 'Sa√≠da')">‚ñº</button>
              </td>
            </tr>`;
        });
      });
    }

    // Busca Inteligente
    window.filtrarTabela = () => {
      const termo = document.getElementById("inputBusca").value.toLowerCase();
      document.querySelectorAll(".row-produto").forEach(row => {
        const nomeProd = row.getAttribute("data-busca");
        let temVolumeVisivel = false;
        let prox = row.nextElementSibling;
        while(prox && prox.classList.contains("row-volume")) {
          const nomeVol = prox.getAttribute("data-busca-vol");
          if(nomeVol.includes(termo) || nomeProd.includes(termo)) {
            prox.style.display = ""; temVolumeVisivel = true;
          } else { prox.style.display = "none"; }
          prox = prox.nextElementSibling;
        }
        row.style.display = (nomeProd.includes(termo) || temVolumeVisivel) ? "" : "none";
      });
    };

    // Modais
    window.movimentar = (id, desc, tipo) => {
      idAtivo = id;
      document.getElementById("modalTitulo").innerText = `${tipo}: ${desc}`;
      document.getElementById("modalCorpo").innerHTML = `<input type="number" id="qtdMov" placeholder="Quantidade" style="width:100%; padding:10px; font-size:18px;">`;
      document.getElementById("btnConfirmar").onclick = async () => {
        const q = parseInt(document.getElementById("qtdMov").value);
        if(!q || q <= 0) return;
        await updateDoc(doc(db, "volumes", idAtivo), { quantidade: increment(tipo === 'Sa√≠da' ? -q : q), ultimaMovimentacao: serverTimestamp() });
        await addDoc(collection(db, "movimentacoes"), { produto: desc, tipo, quantidade: q, usuario: auth.currentUser.email, data: serverTimestamp() });
        fecharModal(); carregarTudo();
      };
      document.getElementById("modalMestre").style.display = "flex";
    };

    window.modalVol = (pId, pNome) => {
      document.getElementById("modalTitulo").innerText = `Novo Volume em ${pNome}`;
      document.getElementById("modalCorpo").innerHTML = `<input type="text" id="nvD" placeholder="Ex: Volume 1/2"><input type="number" id="nvQ" placeholder="Qtd Inicial">`;
      document.getElementById("btnConfirmar").onclick = async () => {
        const d = document.getElementById("nvD").value;
        const q = parseInt(document.getElementById("nvQ").value);
        if(d && q) {
          await addDoc(collection(db, "volumes"), { produtoId: pId, descricao: d, quantidade: q, ultimaMovimentacao: serverTimestamp() });
          fecharModal(); carregarTudo();
        }
      };
      document.getElementById("modalMestre").style.display = "flex";
    };

    window.fecharModal = () => document.getElementById("modalMestre").style.display = "none";
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
  </script>
</body>
</html>
