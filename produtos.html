<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simonetti - Gest√£o de Pulm√£o</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    :root {
      --primary: #004a99;
      --danger: #dc3545;
      --success: #28a745;
    }

    body { background-color: #f0f2f5; margin: 0; font-family: 'Segoe UI', sans-serif; }

    /* Navbar Responsiva */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      color: white;
      padding: 10px 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .user-info { display: flex; align-items: center; gap: 15px; }

    /* Container de Busca */
    .search-container { margin: 20px; }
    .search-container input {
      width: 100%;
      padding: 15px;
      border-radius: 30px;
      border: 2px solid var(--primary);
      box-sizing: border-box;
      font-size: 16px;
      outline: none;
    }

    /* Tabela e Grupos */
    .product-group { background: white; margin: 0 20px 20px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; }
    .prod-header { background: #e9ecef; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; border-left: 5px solid var(--primary); }
    .vol-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; padding: 10px; border-top: 1px solid #eee; align-items: center; }

    @media (max-width: 768px) {
      .vol-row { grid-template-columns: 1fr; gap: 10px; text-align: center; }
    }

    /* Modal Centralizado e Elegante */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

    .modal-header { border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 10px; font-weight: bold; color: var(--primary); }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    input[type="number"], input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }

    .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-edit { background: #f0ad4e; color: white; padding: 5px 10px; font-size: 12px; }
  </style>
</head>
<body>

  <div class="navbar">
    <div class="user-info">
      <a href="dashboard.html"><button class="btn" style="background: #6c757d; color: white;">‚Üê Voltar</button></a>
      <span id="txtSaudacao">Ol√°, Usu√°rio</span>
    </div>
    <div style="font-weight: bold;">M√≥veis Simonetti</div>
    <button class="btn btn-danger" onclick="logout()">Sair</button>
  </div>

  <div class="search-container">
    <input type="text" id="inputBusca" placeholder="üîç Buscar por Produto ou Volume..." onkeyup="filtrarTudo()">
  </div>

  <div id="listaEstoque">
    </div>

  <div id="modalMestre" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitulo">A√ß√£o</div>
      <div id="modalCorpo"></div>
      <div class="modal-footer">
        <button class="btn" onclick="fecharModal()" style="background:#bbb">Cancelar</button>
        <button id="btnConfirmar" class="btn btn-primary">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    // CORRE√á√ÉO DOS IMPORTS
    import { db, auth } from "./js/firebase-config.js";
    
    // Fun√ß√µes de Autentica√ß√£o (onAuthStateChanged VEM DAQUI)
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    
    // Fun√ß√µes de Banco de Dados
    import { 
      collection, addDoc, getDocs, serverTimestamp, doc, updateDoc, increment, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    let idVolumeAtivo = null;

    // Monitorar Usu√°rio
    onAuthStateChanged(auth, user => {
      if (user) {
        const nome = localStorage.getItem("username") || user.email.split('@')[0];
        document.getElementById("txtSaudacao").innerText = `Bem-vindo, ${nome}`;
        carregarDados();
      } else {
        window.location.href = "index.html";
      }
    });

    async function carregarDados() {
      const container = document.getElementById("listaEstoque");
      container.innerHTML = "<p style='text-align:center'>Carregando...</p>";

      try {
        const prodSnap = await getDocs(query(collection(db, "produtos"), orderBy("nome", "asc")));
        const volSnap = await getDocs(collection(db, "volumes"));
        const listaVols = volSnap.docs.map(d => ({id: d.id, ...d.data()}));

        container.innerHTML = "";
        prodSnap.forEach(docP => {
          const p = docP.data();
          const pId = docP.id;
          const volsDoProduto = listaVols.filter(v => v.produtoId === pId);

          let html = `
            <div class="product-group" data-nome="${p.nome.toLowerCase()} ${p.codigo.toLowerCase()}">
              <div class="prod-header">
                <span>${p.codigo} - ${p.nome}</span>
                <button class="btn-edit" onclick="window.addVolume('${pId}', '${p.nome}')">+ Volume</button>
              </div>
          `;

          volsDoProduto.forEach(v => {
            html += `
              <div class="vol-row" data-vol="${v.descricao.toLowerCase()}">
                <div style="padding-left: 20px;">‚Ü≥ ${v.descricao}</div>
                <div style="text-align:center"><strong>${v.quantidade}</strong> un</div>
                <div style="text-align:center; font-size:12px; color:#777">√öltimo giro: ${v.ultimaMovimentacao ? 'Recente' : '--'}</div>
                <div style="display:flex; gap:5px; justify-content:center">
                  <button class="btn btn-success" onclick="window.movimentar('${v.id}', '${v.descricao}', 'Entrada')">‚ñ≤</button>
                  <button class="btn btn-danger" onclick="window.movimentar('${v.id}', '${v.descricao}', 'Sa√≠da')">‚ñº</button>
                </div>
              </div>
            `;
          });
          html += `</div>`;
          container.innerHTML += html;
        });
      } catch (e) { console.error(e); }
    }

    // Busca inteligente: Se achar o volume, mostra o produto pai
    window.filtrarTudo = () => {
      const termo = document.getElementById("inputBusca").value.toLowerCase();
      const grupos = document.querySelectorAll(".product-group");

      grupos.forEach(grupo => {
        const nomeProd = grupo.getAttribute("data-nome");
        const linhasVol = grupo.querySelectorAll(".vol-row");
        let achouNoVolume = false;

        linhasVol.forEach(linha => {
          const nomeVol = linha.getAttribute("data-vol");
          if(nomeVol.includes(termo) || nomeProd.includes(termo)) {
            linha.style.display = "grid";
            achouNoVolume = true;
          } else {
            linha.style.display = "none";
          }
        });
        grupo.style.display = (nomeProd.includes(termo) || achouNoVolume) ? "block" : "none";
      });
    };

    window.movimentar = (id, desc, tipo) => {
      idVolumeAtivo = id;
      document.getElementById("modalTitulo").innerText = `${tipo}: ${desc}`;
      document.getElementById("modalCorpo").innerHTML = `
        <p>Informe a quantidade para ${tipo.toLowerCase()}:</p>
        <input type="number" id="qtdMov" placeholder="0" style="font-size: 20px; text-align:center">
      `;
      document.getElementById("btnConfirmar").onclick = () => salvarMov(tipo, desc);
      document.getElementById("modalMestre").style.display = "flex";
    };

    const salvarMov = async (tipo, desc) => {
      const qtd = parseInt(document.getElementById("qtdMov").value);
      if(!qtd || qtd <= 0) return;

      const vRef = doc(db, "volumes", idVolumeAtivo);
      await updateDoc(vRef, {
        quantidade: increment(tipo === 'Sa√≠da' ? -qtd : qtd),
        ultimaMovimentacao: serverTimestamp()
      });

      await addDoc(collection(db, "movimentacoes"), {
        produto: desc, tipo, quantidade: qtd, usuario: auth.currentUser.email, data: serverTimestamp()
      });

      fecharModal();
      carregarDados();
    };

    window.addVolume = (pId, pNome) => {
      document.getElementById("modalTitulo").innerText = `Novo Volume: ${pNome}`;
      document.getElementById("modalCorpo").innerHTML = `
        <input type="text" id="nvDesc" placeholder="Descri√ß√£o do Volume (ex: Lateral Dir.)">
        <input type="number" id="nvQtd" placeholder="Quantidade inicial">
      `;
      document.getElementById("btnConfirmar").onclick = async () => {
        const d = document.getElementById("nvDesc").value;
        const q = parseInt(document.getElementById("nvQtd").value);
        if(d && q) {
          await addDoc(collection(db, "volumes"), { produtoId: pId, descricao: d, quantidade: q, ultimaMovimentacao: serverTimestamp() });
          fecharModal();
          carregarDados();
        }
      };
      document.getElementById("modalMestre").style.display = "flex";
    };

    window.fecharModal = () => document.getElementById("modalMestre").style.display = "none";
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

  </script>
</body>
</html>
